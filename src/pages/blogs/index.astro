---
import MainLayout from '@/layouts/MainLayout.astro';

const convexUrl = import.meta.env.PUBLIC_CONVEX_URL;

if (!convexUrl) {
  throw new Error('PUBLIC_CONVEX_URL is not set');
}

export const prerender = false;

// Define blog type
interface Blog {
  _id: string;
  title: string;
  slug: string;
  excerpt: string;
  authorName: string;
  tags: string[];
  status: string;
  featured: boolean;
  publishedAt?: number;
  createdAt: number;
}

// Server-side data fetching using Convex HTTP API
let blogs: Blog[] = [];

try {
  const response = await fetch(`${convexUrl}/api/query`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      path: 'blogs:getPublishedBlogs',
      args: {},
    }),
  });
  
  if (response.ok) {
    const result = await response.json();
    blogs = result.value || [];
  }
} catch (error) {
  console.error('Error fetching blogs for SSR:', error);
}

// Format date helper
function formatDate(timestamp: number | undefined): string {
  if (!timestamp) return '';
  return new Date(timestamp).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

const title = "Blog | Church Prompt Directory";
const description = "Explore insights, tips, and resources for creating better AI prompts for church ministry and spiritual growth.";
const keywords = "church blog, ministry insights, AI prompts, pastoral care, spiritual growth, church technology";
const canonicalUrl = `${Astro.site?.toString() || 'https://churchprompt.directory'}/blogs`;
---

<MainLayout 
  title={title} 
  description={description}
  keywords={keywords}
  canonicalUrl={canonicalUrl}
  ogType="website"
>
  <div class="container py-12">
    <div class="mb-12 text-center max-w-3xl mx-auto">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">Blog</h1>
      <p class="text-lg text-muted-foreground">
        Insights, tips, and resources for leveraging AI in church ministry
      </p>
    </div>
    
    {blogs.length === 0 ? (
      <div class="text-center py-12">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 opacity-50"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>
        <h2 class="text-xl font-semibold mb-2">No blog posts yet</h2>
        <p class="text-muted-foreground">Check back soon for insights and resources!</p>
      </div>
    ) : (
      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {blogs.map((blog) => (
          <article class="rounded-lg border bg-card text-card-foreground shadow-sm hover:shadow-md transition-shadow" itemscope itemtype="https://schema.org/BlogPosting">
            <a href={`/blogs/${blog.slug}`} class="block p-6">
              <div class="flex items-start justify-between mb-3">
                <div class="flex flex-wrap gap-2">
                  {blog.featured && (
                    <span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-primary text-primary-foreground">
                      Featured
                    </span>
                  )}
                </div>
              </div>
              
              <h2 class="text-xl font-semibold mb-2 line-clamp-2 hover:text-primary transition-colors" itemprop="headline">
                {blog.title}
              </h2>
              
              <p class="text-muted-foreground text-sm mb-4 line-clamp-3" itemprop="description">
                {blog.excerpt}
              </p>
              
              <div class="flex items-center justify-between text-xs text-muted-foreground">
                <div class="flex items-center gap-4">
                  <time datetime={blog.publishedAt ? new Date(blog.publishedAt).toISOString() : ''} itemprop="datePublished" class="flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
                    {formatDate(blog.publishedAt)}
                  </time>
                  <span class="flex items-center gap-1" itemprop="author">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    {blog.authorName}
                  </span>
                </div>
              </div>
              
              {blog.tags.length > 0 && (
                <div class="flex flex-wrap gap-1 mt-4">
                  {blog.tags.slice(0, 3).map((tag) => (
                    <span class="inline-flex items-center rounded-full border px-2 py-0.5 text-xs" itemprop="keywords">
                      {tag}
                    </span>
                  ))}
                  {blog.tags.length > 3 && (
                    <span class="text-xs text-muted-foreground">+{blog.tags.length - 3} more</span>
                  )}
                </div>
              )}
            </a>
          </article>
        ))}
      </div>
    )}
  </div>
</MainLayout>
