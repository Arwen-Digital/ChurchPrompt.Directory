---
import MainLayout from '@/layouts/MainLayout.astro';
import { marked } from 'marked';

const convexUrl = import.meta.env.PUBLIC_CONVEX_URL;

if (!convexUrl) {
  throw new Error('PUBLIC_CONVEX_URL is not set');
}

export const prerender = false;

const { slug } = Astro.params;

// Define blog type
interface Blog {
  _id: string;
  title: string;
  slug: string;
  content: string;
  excerpt: string;
  authorName: string;
  tags: string[];
  metaDescription: string;
  metaKeywords: string[];
  status: string;
  featured: boolean;
  publishedAt?: number;
  createdAt: number;
  updatedAt: number;
  featuredImage?: string;
}

// Server-side data fetching using Convex HTTP API
let blog: Blog | null = null;
let title = "Blog Post | Church Prompt Directory";
let description = "Read our latest insights and tips for church ministry.";
let keywords = "church, ministry, AI prompts, spiritual growth";
let ogImage = "";
let canonicalUrl = `${Astro.site?.toString() || 'https://churchprompt.directory'}/blogs/${slug}`;

try {
  // Use Convex HTTP API directly (works in any environment)
  const response = await fetch(`${convexUrl}/api/query`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      path: 'blogs:getBlogBySlug',
      args: { slug: slug || '' },
    }),
  });
  
  if (response.ok) {
    const result = await response.json();
    blog = result.value;
  }
  
  if (blog) {
    title = `${blog.title} | Church Prompt Directory`;
    description = blog.metaDescription || blog.excerpt;
    keywords = blog.metaKeywords.join(', ');
    ogImage = blog.featuredImage || `${Astro.site?.toString() || 'https://churchprompt.directory'}/og-image.png`;
  }
} catch (error) {
  console.error('Error fetching blog for SSR:', error);
}

// If blog not found, return 404
if (!blog) {
  return Astro.redirect('/404');
}

// Format date helper
function formatDate(timestamp: number | undefined): string {
  if (!timestamp) return '';
  return new Date(timestamp).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

// Configure marked for safe rendering
marked.setOptions({
  gfm: true,
  breaks: true,
});

// Render markdown to HTML on the server
const contentHtml = marked.parse(blog.content);
---

<MainLayout 
  title={title} 
  description={description}
  keywords={keywords}
  ogTitle={title}
  ogDescription={description}
  ogImage={ogImage}
  ogType="article"
  canonicalUrl={canonicalUrl}
>
  <div class="container py-12">
    <div class="max-w-4xl mx-auto">
      <!-- Back button -->
      <div class="mb-6">
        <a href="/blogs" class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
          Back to Blog
        </a>
      </div>

      <article itemscope itemtype="https://schema.org/BlogPosting">
        <!-- Header -->
        <header class="mb-8">
          {blog.featured && (
            <span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-primary text-primary-foreground mb-4">
              Featured
            </span>
          )}
          <h1 class="text-4xl md:text-5xl font-bold mb-4" itemprop="headline">{blog.title}</h1>
          
          <!-- Meta information -->
          <div class="flex flex-wrap items-center gap-4 text-sm text-muted-foreground mb-6">
            <time datetime={blog.publishedAt ? new Date(blog.publishedAt).toISOString() : ''} itemprop="datePublished" class="flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
              {formatDate(blog.publishedAt)}
            </time>
            <span class="flex items-center gap-1" itemprop="author" itemscope itemtype="https://schema.org/Person">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              <span itemprop="name">{blog.authorName}</span>
            </span>
          </div>

          <!-- Excerpt -->
          {blog.excerpt && (
            <p class="text-lg text-muted-foreground italic border-l-4 border-primary pl-4 py-2" itemprop="description">
              {blog.excerpt}
            </p>
          )}
        </header>

        <!-- Content - Server-rendered HTML -->
        <div class="rounded-lg border bg-card text-card-foreground shadow-sm mb-8">
          <div class="p-6 pt-6">
            <div 
              class="prose prose-slate dark:prose-invert max-w-none
                prose-headings:font-bold
                prose-h1:text-3xl prose-h1:mt-8 prose-h1:mb-4
                prose-h2:text-2xl prose-h2:mt-6 prose-h2:mb-3
                prose-h3:text-xl prose-h3:mt-4 prose-h3:mb-2
                prose-p:mb-4 prose-p:leading-7
                prose-ul:list-disc prose-ul:list-inside prose-ul:mb-4 prose-ul:space-y-2
                prose-ol:list-decimal prose-ol:list-inside prose-ol:mb-4 prose-ol:space-y-2
                prose-li:ml-4
                prose-a:text-primary prose-a:hover:underline
                prose-blockquote:border-l-4 prose-blockquote:border-muted-foreground prose-blockquote:pl-4 prose-blockquote:italic prose-blockquote:my-4 prose-blockquote:text-muted-foreground
                prose-code:bg-muted prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-sm prose-code:font-mono
                prose-pre:bg-muted prose-pre:p-4 prose-pre:rounded-lg prose-pre:overflow-x-auto prose-pre:my-4"
              itemprop="articleBody"
              set:html={contentHtml}
            />
          </div>
        </div>

        <!-- Tags -->
        {blog.tags.length > 0 && (
          <div class="flex items-center gap-3 flex-wrap">
            <span class="flex items-center gap-2 text-sm font-semibold">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z"/><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"/></svg>
              Tags:
            </span>
            {blog.tags.map((tag) => (
              <span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold" itemprop="keywords">
                {tag}
              </span>
            ))}
          </div>
        )}

        <!-- Footer navigation -->
        <div class="mt-12 pt-8 border-t">
          <a href="/blogs" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
            Back to All Posts
          </a>
        </div>
      </article>
    </div>
  </div>
</MainLayout>
