---
import MainLayout from "@/layouts/MainLayout.astro";
import { marked } from "marked";

const convexUrl = import.meta.env.PUBLIC_CONVEX_URL;

if (!convexUrl) {
  throw new Error("PUBLIC_CONVEX_URL is not set");
}

export const prerender = false;

const { slug } = Astro.params;

// Define blog type
interface Blog {
  _id: string;
  title: string;
  slug: string;
  content: string;
  excerpt: string;
  authorName: string;
  tags: string[];
  metaDescription: string;
  metaKeywords: string[];
  status: string;
  featured: boolean;
  publishedAt?: number;
  createdAt: number;
  updatedAt: number;
  featuredImage?: string;
}

// Server-side data fetching using Convex HTTP API
let blog: Blog | null = null;
let title = "Blog Post | Church Prompt Directory";
let description = "Read our latest insights and tips for church ministry.";
let keywords = "church, ministry, AI prompts, spiritual growth";
let ogImage = "";
let canonicalUrl = `${Astro.site?.toString() || "https://churchprompt.directory"}/blogs/${slug}`;

try {
  // Use Convex HTTP API directly (works in any environment)
  const response = await fetch(`${convexUrl}/api/query`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      path: "blogs:getBlogBySlug",
      args: { slug: slug || "" },
    }),
  });

  if (response.ok) {
    const result = await response.json();
    blog = result.value;
  }

  if (blog) {
    title = `${blog.title} | Church Prompt Directory`;
    description = blog.metaDescription || blog.excerpt;
    keywords = blog.metaKeywords.join(", ");
    ogImage =
      blog.featuredImage ||
      `${Astro.site?.toString() || "https://churchprompt.directory"}/blog-og-default.png`;
  }
} catch (error) {
  console.error("Error fetching blog for SSR:", error);
}

// If blog not found, return 404
if (!blog) {
  return Astro.redirect("/404");
}

// Format date helper
function formatDate(timestamp: number | undefined): string {
  if (!timestamp) return "";
  return new Date(timestamp).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

// Configure marked for safe rendering
marked.setOptions({
  gfm: true,
  breaks: true,
});

// Render markdown to HTML on the server
const contentHtml = marked.parse(blog.content);
---

<MainLayout
  title={title}
  description={description}
  keywords={keywords}
  ogTitle={title}
  ogDescription={description}
  ogImage={ogImage}
  ogType="article"
  canonicalUrl={canonicalUrl}
>
  <style is:global>
    .blog-content p {
      margin-bottom: 1em !important;
      margin-top: 0 !important;
    }

    .blog-content p a {
      text-decoration: underline;
      text-underline-offset: 2px;
      transition: all 0.2s;
    }

    /* Fixed code block styling */
    .blog-content pre {
      background-color: #1a1a1a !important;
      color: #e0e0e0 !important;
      border: 1px solid #333333 !important;
      border-radius: 0.5rem !important;
      padding: 1rem !important;
      margin-top: 1.5em !important;
      margin-bottom: 1.5em !important;
      overflow-x: auto !important;
      white-space: pre-wrap !important; /* Forces text wrapping within container */
      word-wrap: break-word !important; /* Ensures long words break if needed */
      max-width: 100% !important;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }

    .blog-content pre code {
      background-color: transparent !important;
      color: inherit !important;
      padding: 0 !important;
      border-radius: 0 !important;
      font-size: 0.875em !important;
      font-family:
        ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace !important;
      white-space: pre-wrap !important; /* Inherit wrapping */
      word-break: break-word !important;
    }
  </style>

  <article itemscope itemtype="https://schema.org/BlogPosting" class="w-full">
    <!-- Header Section -->
    <header class="max-w-[700px] mx-auto mb-12 mt-8 px-5 md:px-0">
      <h1
        class="text-[32px] md:text-[42px] font-bold tracking-tight mb-2 text-[#242424] leading-[1.15]"
        itemprop="headline"
        style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
      >
        {blog.title}
      </h1>

      {
        blog.excerpt && (
          <p
            class="text-[20px] md:text-[22px] text-[#6B6B6B] mb-8 leading-[1.4] mt-2"
            itemprop="description"
            style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
          >
            {blog.excerpt}
          </p>
        )
      }

      <!-- Author / Meta -->
      <div class="flex items-center gap-3 text-[14px]">
        <div
          class="w-10 h-10 rounded-full bg-muted flex items-center justify-center overflow-hidden"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="text-muted-foreground"
            ><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle
              cx="12"
              cy="7"
              r="4"></circle></svg
          >
        </div>
        <div class="flex flex-col leading-snug">
          <span
            itemprop="author"
            itemscope
            itemtype="https://schema.org/Person"
            class="font-medium text-[#242424]"
            style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
          >
            <span itemprop="name">{blog.authorName}</span>
          </span>
          <div
            class="flex items-center gap-1 text-[#6B6B6B]"
            style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
          >
            <span>5 min read</span>
            <span>·</span>
            <time
              datetime={blog.publishedAt
                ? new Date(blog.publishedAt).toISOString()
                : ""}
              itemprop="datePublished"
            >
              {formatDate(blog.publishedAt)}
            </time>
          </div>
        </div>
      </div>
    </header>

    <!-- Featured Image (Wide) -->
    {
      blog.featuredImage && (
        <div class="max-w-screen-lg mx-auto mb-14">
          <div class="aspect-[2/1] w-full overflow-hidden bg-muted">
            <img
              src={blog.featuredImage}
              alt={blog.title}
              class="w-full h-full object-cover"
              itemprop="image"
            />
          </div>
        </div>
      )
    }

    <!-- Content -->
    <div class="max-w-[700px] mx-auto mb-20 px-5 md:px-0">
      <div
        class="blog-content prose prose-slate dark:prose-invert max-w-none
              text-[20px] leading-[1.58] text-[rgba(41,41,41,1)]
              prose-headings:font-bold prose-headings:tracking-tight prose-headings:text-[#242424]
              prose-headings:font-sans
              prose-h1:text-[32px] prose-h1:mt-[2.5em] prose-h1:mb-[0.8em]
              prose-h2:text-[26px] prosse-h2:mt-[2em] prose-h2:mb-[0.6em]
              prose-h3:text-[22px] prose-h3:mt-[1.8em] prose-h3:mb-[0.5em]
              prose-ul:my-[1.5em] prose-ul:pl-6
              prose-ol:my-[1.5em] prose-ol:pl-6
              prose-li:mb-[0.5em]
              prose-a:text-[#242424] prose-a:underline prose-a:decoration-[#6B6B6B] prose-a:underline-offset-2 prose-a:hover:decoration-[#242424] prose-a:transition-all
              prose-blockquote:border-l-[3px] prose-blockquote:border-[#242424] prose-blockquote:pl-5 prose-blockquote:italic prose-blockquote:my-[1.5em] prose-blockquote:text-[24px] prose-blockquote:leading-[1.4] prose-blockquote:text-[#242424]
              prose-img:my-[2em] prose-img:w-full
              prose-code:font-mono prose-code:text-[0.85em] prose-code:bg-[#F2F2F2] prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded
              prose-pre:bg-[#1A1A1A] prose-pre:text-[#E0E0E0] prose-pre:border prose-pre:border-[#333333] prose-pre:p-4 prose-pre:rounded-lg prose-pre:my-[1.5em] prose-pre:overflow-x-auto prose-pre:shadow-sm"
        itemprop="articleBody"
        set:html={contentHtml}
        style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
      />

      <!-- Tags -->
      {
        blog.tags.length > 0 && (
          <div class="mt-14 pt-8 flex flex-wrap gap-2">
            {blog.tags.map((tag) => (
              <a
                href={`/blogs?tag=${tag}`}
                class="inline-flex items-center rounded-full bg-[#F2F2F2] px-4 py-2 text-[14px] text-[#242424] hover:bg-[#E6E6E6] transition-colors"
                style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
              >
                {tag}
              </a>
            ))}
          </div>
        )
      }

      <!-- Footer navigation -->
      <div class="mt-10 py-8 border-t border-[#F2F2F2]">
        <a
          href="/blogs"
          class="text-[15px] font-medium text-[#6B6B6B] hover:text-[#242424] transition-colors flex items-center gap-2"
          style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg
          >
          Back to all posts
        </a>
      </div>

      <!-- Related Prompts Section -->
      {
        convexUrl
          ? await (async () => {
              try {
                const response = await fetch(`${convexUrl}/api/query`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    path: "prompts:getApprovedPrompts",
                    args: { limit: 3 },
                    format: "json",
                  }),
                });
                const json = response.ok
                  ? await response.json()
                  : { value: { prompts: [] } };
                const relatedPrompts = (json.value?.prompts || []).slice(0, 3);

                if (relatedPrompts.length > 0) {
                  return (
                    <div class="mt-16 pt-8 border-t border-[#F2F2F2]">
                      <h3
                        class="text-[24px] font-bold mb-6 text-[#242424]"
                        style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
                      >
                        Try These AI Prompts
                      </h3>
                      <div class="grid gap-4 md:grid-cols-3">
                        {relatedPrompts.map((prompt: any) => (
                          <a
                            href={`/directory/${prompt.id || prompt._id}`}
                            class="block group rounded-lg border border-[#F2F2F2] bg-white p-5 hover:border-[#242424] hover:shadow-sm transition-all"
                          >
                            <div class="flex items-start justify-between mb-2">
                              <h4
                                class="text-[16px] font-semibold text-[#242424] line-clamp-2 group-hover:text-primary transition-colors"
                                style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
                              >
                                {prompt.title}
                              </h4>
                            </div>
                            <p
                              class="text-[14px] text-[#6B6B6B] line-clamp-2 mb-3"
                              style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
                            >
                              {prompt.excerpt ||
                                prompt.content?.substring(0, 100)}
                            </p>
                            <div class="flex items-center gap-2">
                              <span
                                class="inline-flex items-center rounded-full bg-[#F2F2F2] px-2.5 py-0.5 text-[12px] text-[#6B6B6B]"
                                style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
                              >
                                {prompt.category}
                              </span>
                            </div>
                          </a>
                        ))}
                      </div>
                      <div class="mt-6 text-center">
                        <a
                          href="/directory"
                          class="inline-flex items-center gap-2 text-[15px] font-medium text-primary hover:underline"
                          style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
                        >
                          Browse all prompts
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <path d="M5 12h14" />
                            <path d="m12 5 7 7-7 7" />
                          </svg>
                        </a>
                      </div>
                    </div>
                  );
                }
              } catch (e) {
                console.error("Error fetching related prompts:", e);
              }
              return null;
            })()
          : null
      }

      <!-- Related Blog Posts Section -->
      {
        convexUrl
          ? await (async () => {
              try {
                const response = await fetch(`${convexUrl}/api/query`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    path: "blogs:getPublishedBlogs",
                    args: {},
                    format: "json",
                  }),
                });
                const json = response.ok
                  ? await response.json()
                  : { value: [] };
                const allBlogs = json.value || [];
                // Filter out current blog and get 3 random related posts
                const otherBlogs = allBlogs.filter((b: any) => b.slug !== slug);
                const relatedBlogs = otherBlogs.slice(0, 3);

                if (relatedBlogs.length > 0) {
                  return (
                    <div class="mt-16 pt-8 border-t border-[#F2F2F2]">
                      <h3
                        class="text-[24px] font-bold mb-6 text-[#242424]"
                        style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
                      >
                        Related Articles
                      </h3>
                      <div class="grid gap-6 md:grid-cols-3">
                        {relatedBlogs.map((relatedBlog: any) => (
                          <a
                            href={`/blogs/${relatedBlog.slug}`}
                            class="block group"
                          >
                            <article class="h-full">
                              <h4
                                class="text-[18px] font-semibold text-[#242424] mb-2 line-clamp-2 group-hover:text-primary transition-colors"
                                style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
                              >
                                {relatedBlog.title}
                              </h4>
                              <p
                                class="text-[14px] text-[#6B6B6B] line-clamp-3 mb-3"
                                style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
                              >
                                {relatedBlog.excerpt}
                              </p>
                              <div
                                class="flex items-center gap-2 text-[13px] text-[#6B6B6B]"
                                style="font-family: sohne, 'Helvetica Neue', Helvetica, Arial, sans-serif;"
                              >
                                <span>{relatedBlog.authorName}</span>
                                <span>·</span>
                                <time
                                  datetime={
                                    relatedBlog.publishedAt
                                      ? new Date(
                                          relatedBlog.publishedAt,
                                        ).toISOString()
                                      : ""
                                  }
                                >
                                  {new Date(
                                    relatedBlog.publishedAt ||
                                      relatedBlog.createdAt,
                                  ).toLocaleDateString("en-US", {
                                    month: "short",
                                    day: "numeric",
                                    year: "numeric",
                                  })}
                                </time>
                              </div>
                            </article>
                          </a>
                        ))}
                      </div>
                    </div>
                  );
                }
              } catch (e) {
                console.error("Error fetching related blogs:", e);
              }
              return null;
            })()
          : null
      }
    </div>
  </article>
</MainLayout>
